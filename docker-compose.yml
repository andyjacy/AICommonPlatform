version: '3.8'

services:
  # ==================== 基础服务 ====================
  
  # PostgreSQL - 关系数据库
  postgres:
    image: postgres:15-alpine
    container_name: ai_platform_postgres
    environment:
      POSTGRES_DB: ai_platform
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ai_platform_2024
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai_platform_net

  # Redis - 缓存和消息队列
  redis:
    image: redis:7-alpine
    container_name: ai_platform_redis
    command: redis-server --appendonly yes --requirepass ai_redis_2024
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai_platform_net

  # Milvus - 向量数据库
  milvus:
    image: milvusdb/milvus:latest
    container_name: ai_platform_milvus
    environment:
      COMMON_STORAGETYPE: local
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - ai_platform_net



  # ==================== 应用服务 ====================

  # QA Entry Service - 问答入口
  qa_entry:
    build:
      context: ./services/qa_entry
      dockerfile: Dockerfile
    container_name: ai_platform_qa_entry
    ports:
      - "8001:8000"
    environment:
      SERVICE_NAME: qa_entry
      REDIS_URL: redis://:ai_redis_2024@redis:6379/0
      DB_URL: postgresql://admin:ai_platform_2024@postgres:5432/ai_platform
      MILVUS_HOST: milvus
      MILVUS_PORT: 19530
      PROMPT_SERVICE_URL: http://prompt_service:8000
      RAG_SERVICE_URL: http://rag_service:8000
      AGENT_SERVICE_URL: http://agent_service:8000
      LLM_SERVICE_URL: http://llm_service:8000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      milvus:
        condition: service_healthy
    networks:
      - ai_platform_net
    restart: unless-stopped

  # Prompt Service - Prompt管理层
  prompt_service:
    build:
      context: ./services/prompt_service
      dockerfile: Dockerfile
    container_name: ai_platform_prompt_service
    ports:
      - "8002:8000"
    environment:
      SERVICE_NAME: prompt_service
      REDIS_URL: redis://:ai_redis_2024@redis:6379/1
      DB_URL: postgresql://admin:ai_platform_2024@postgres:5432/ai_platform
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai_platform_net
    restart: unless-stopped

  # RAG Service - 知识库和检索
  rag_service:
    build:
      context: ./services/rag_service
      dockerfile: Dockerfile
    container_name: ai_platform_rag_service
    ports:
      - "8003:8000"
    environment:
      SERVICE_NAME: rag_service
      REDIS_URL: redis://:ai_redis_2024@redis:6379/2
      DB_URL: postgresql://admin:ai_platform_2024@postgres:5432/ai_platform
      MILVUS_HOST: milvus
      MILVUS_PORT: 19530
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      milvus:
        condition: service_healthy
    volumes:
      - rag_documents:/app/documents
    networks:
      - ai_platform_net
    restart: unless-stopped

  # Agent Service - Agent执行层
  agent_service:
    build:
      context: ./services/agent_service
      dockerfile: Dockerfile
    container_name: ai_platform_agent_service
    ports:
      - "8004:8000"
    environment:
      SERVICE_NAME: agent_service
      REDIS_URL: redis://:ai_redis_2024@redis:6379/3
      DB_URL: postgresql://admin:ai_platform_2024@postgres:5432/ai_platform
      INTEGRATION_SERVICE_URL: http://integration:8000
      LLM_SERVICE_URL: http://llm_service:8000
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai_platform_net
    restart: unless-stopped

  # Integration Service - 企业系统集成
  integration:
    build:
      context: ./services/integration
      dockerfile: Dockerfile
    container_name: ai_platform_integration
    ports:
      - "8005:8000"
    environment:
      SERVICE_NAME: integration
      REDIS_URL: redis://:ai_redis_2024@redis:6379/4
      DB_URL: postgresql://admin:ai_platform_2024@postgres:5432/ai_platform
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai_platform_net
    restart: unless-stopped

  # LLM Service - 大模型接口
  llm_service:
    build:
      context: ./services/llm_service
      dockerfile: Dockerfile
    container_name: ai_platform_llm_service
    ports:
      - "8006:8000"
    environment:
      SERVICE_NAME: llm_service
      REDIS_URL: redis://:ai_redis_2024@redis:6379/5
      DB_URL: postgresql://admin:ai_platform_2024@postgres:5432/ai_platform
      # 配置LLM模型
      LLM_PROVIDER: openai  # 可选: openai, aliyun, baidu
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-demo}
      OPENAI_BASE_URL: https://api.openai.com/v1
      MODEL_NAME: gpt-3.5-turbo
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - ai_platform_net
    restart: unless-stopped


  # ==================== Web UI 界面 ====================

  # Web UI - 交互式界面
  web_ui:
    build:
      context: ./services/web_ui
      dockerfile: Dockerfile
    container_name: ai_platform_web_ui
    ports:
      - "3000:3000"
    environment:
      QA_SERVICE_URL: http://qa_entry:8000
      PROMPT_SERVICE_URL: http://prompt_service:8000
      RAG_SERVICE_URL: http://rag_service:8000
      AGENT_SERVICE_URL: http://agent_service:8000
      INTEGRATION_SERVICE_URL: http://integration:8000
      LLM_SERVICE_URL: http://llm_service:8000
    depends_on:
      - qa_entry
      - prompt_service
      - rag_service
      - agent_service
      - integration
      - llm_service
    networks:
      - ai_platform_net
    restart: unless-stopped


# ==================== 网络 ====================
networks:
  ai_platform_net:
    driver: bridge

# ==================== 持久化卷 ====================
volumes:
  postgres_data:
  redis_data:
  milvus_data:
  rag_documents:
