<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>LLM æ¨¡å‹æ›´æ–°æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { background-color: #d4edda; color: #155724; padding: 10px; margin: 10px 0; }
        .error { background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; }
        pre { background-color: #f5f5f5; padding: 10px; overflow-x: auto; }
        #debug { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª LLM æ¨¡å‹æ›´æ–°æµ‹è¯•</h1>
        
        <h2>æ¨¡å‹è¡¨å•</h2>
        <div>
            <label>æ¨¡å‹ IDï¼ˆç¼–è¾‘ï¼‰:</label>
            <input type="number" id="modelId" value="2">
        </div>
        
        <div>
            <label>æ¨¡å‹åç§°:</label>
            <input type="text" id="llmName" value="OpenAI GPT-3.5 Turbo">
        </div>
        
        <div>
            <label>æä¾›å•†:</label>
            <select id="llmProvider">
                <option value="">-- é€‰æ‹© --</option>
                <option value="OpenAI" selected>OpenAI</option>
                <option value="Aliyun">é˜¿é‡Œäº‘</option>
            </select>
        </div>
        
        <div>
            <label>æ¨¡å‹ç±»å‹:</label>
            <select id="llmType">
                <option value="api" selected>API</option>
                <option value="local">æœ¬åœ°</option>
            </select>
        </div>
        
        <div>
            <label>API ç«¯ç‚¹:</label>
            <input type="text" id="llmEndpoint" value="https://api.openai.com/v1/chat/completions">
        </div>
        
        <div>
            <label>API Key:</label>
            <input type="password" id="llmApiKey" value="sk-test">
        </div>
        
        <div>
            <label>Base URL:</label>
            <input type="text" id="llmBaseUrl" value="">
        </div>
        
        <div>
            <label>Max Tokens:</label>
            <input type="number" id="llmMaxTokens" value="2048">
        </div>
        
        <div>
            <label>Temperature:</label>
            <input type="number" id="llmTemperature" value="0.7" step="0.1" min="0" max="2">
        </div>
        
        <div>
            <label>æè¿°:</label>
            <textarea id="llmDescription" rows="3">Test model</textarea>
        </div>
        
        <h2>æ“ä½œ</h2>
        <button onclick="testEdit()">æµ‹è¯•ç¼–è¾‘ï¼ˆè®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼ï¼‰</button>
        <button onclick="testCreate()">æµ‹è¯•åˆ›å»ºï¼ˆè®¾ç½®ä¸ºåˆ›å»ºæ¨¡å¼ï¼‰</button>
        <button onclick="simulateSave()">æ¨¡æ‹Ÿ saveLLMModel()</button>
        <button onclick="sendPUT()">å‘é€ PUT è¯·æ±‚</button>
        <button onclick="sendPOST()">å‘é€ POST è¯·æ±‚</button>
        
        <h2>è°ƒè¯•è¾“å‡º</h2>
        <div id="debug"></div>
    </div>
    
    <script>
        function log(msg) {
            const debug = document.getElementById('debug');
            debug.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
            debug.scrollTop = debug.scrollHeight;
        }
        
        function getFormData() {
            const getElementValue = (id, defaultVal = '') => {
                const elem = document.getElementById(id);
                return elem ? elem.value : defaultVal;
            };
            
            const name = getElementValue('llmName', '').trim();
            const provider = getElementValue('llmProvider', '');
            const modelType = getElementValue('llmType', 'api');
            const endpoint = getElementValue('llmEndpoint', '').trim();
            const apiKey = getElementValue('llmApiKey', '').trim();
            const baseUrl = getElementValue('llmBaseUrl', '').trim();
            
            const maxTokensStr = getElementValue('llmMaxTokens', '2048');
            const maxTokens = parseInt(maxTokensStr) || 2048;
            const temperatureStr = getElementValue('llmTemperature', '0.7');
            const temperature = parseFloat(temperatureStr) || 0.7;
            
            const description = getElementValue('llmDescription', '').trim();
            
            return {
                name, provider, modelType, endpoint, apiKey, baseUrl, 
                maxTokens, temperature, description
            };
        }
        
        function testEdit() {
            window.currentEditingModelId = parseInt(document.getElementById('modelId').value);
            window.isEnteringEditMode = true;
            log('âœ“ è®¾ç½®ç¼–è¾‘æ¨¡å¼ï¼ŒmodelId=' + window.currentEditingModelId);
        }
        
        function testCreate() {
            window.currentEditingModelId = null;
            window.isEnteringEditMode = false;
            log('âœ“ è®¾ç½®åˆ›å»ºæ¨¡å¼');
        }
        
        function simulateSave() {
            const formData = getFormData();
            const isEditing = window.currentEditingModelId != null;
            const modelId = isEditing ? window.currentEditingModelId : null;
            
            log('=== æ¨¡æ‹Ÿ saveLLMModel() ===');
            log('ç¼–è¾‘æ¨¡å¼: ' + isEditing);
            log('æ¨¡å‹ ID: ' + modelId);
            log('è¡¨å•æ•°æ®: ' + JSON.stringify(formData));
            
            let requestData = {};
            
            if (isEditing) {
                log('â†’ æ„å»ºç¼–è¾‘è¯·æ±‚...');
                if (formData.provider) requestData.provider = formData.provider;
                if (formData.modelType) requestData.model_type = formData.modelType;
                if (formData.maxTokens !== undefined && !isNaN(formData.maxTokens)) requestData.max_tokens = formData.maxTokens;
                if (formData.temperature !== undefined && !isNaN(formData.temperature)) requestData.temperature = formData.temperature;
                if (formData.endpoint) requestData.endpoint = formData.endpoint;
                if (formData.apiKey) requestData.api_key = formData.apiKey;
                if (formData.baseUrl) requestData.base_url = formData.baseUrl;
                if (formData.description) requestData.description = formData.description;
            } else {
                log('â†’ æ„å»ºåˆ›å»ºè¯·æ±‚...');
                requestData = {
                    name: formData.name, 
                    provider: formData.provider, 
                    model_type: formData.modelType
                };
                if (formData.maxTokens !== undefined && !isNaN(formData.maxTokens)) requestData.max_tokens = formData.maxTokens;
                if (formData.temperature !== undefined && !isNaN(formData.temperature)) requestData.temperature = formData.temperature;
                if (formData.endpoint) requestData.endpoint = formData.endpoint;
                if (formData.apiKey) requestData.api_key = formData.apiKey;
                if (formData.baseUrl) requestData.base_url = formData.baseUrl;
                if (formData.description) requestData.description = formData.description;
            }
            
            log('è¯·æ±‚æ•°æ®: ' + JSON.stringify(requestData));
            
            // é€å­—æ®µåˆ†æ
            for (const [key, value] of Object.entries(requestData)) {
                log(`  ${key}: ${JSON.stringify(value)} (${typeof value})`);
            }
        }
        
        async function sendPUT() {
            const formData = getFormData();
            const modelId = window.currentEditingModelId;
            
            if (!modelId) {
                log('âŒ é”™è¯¯ï¼šæœªè®¾ç½® modelIdï¼Œè¯·å…ˆç‚¹å‡»"æµ‹è¯•ç¼–è¾‘"');
                return;
            }
            
            let requestData = {};
            if (formData.provider) requestData.provider = formData.provider;
            if (formData.modelType) requestData.model_type = formData.modelType;
            if (formData.maxTokens !== undefined && !isNaN(formData.maxTokens)) requestData.max_tokens = formData.maxTokens;
            if (formData.temperature !== undefined && !isNaN(formData.temperature)) requestData.temperature = formData.temperature;
            if (formData.endpoint) requestData.endpoint = formData.endpoint;
            if (formData.apiKey) requestData.api_key = formData.apiKey;
            if (formData.baseUrl) requestData.base_url = formData.baseUrl;
            if (formData.description) requestData.description = formData.description;
            
            const url = `/api/llm/models/${modelId}`;
            const body = JSON.stringify(requestData);
            
            log(`â†’ å‘é€ PUT è¯·æ±‚åˆ° ${url}`);
            log(`è¯·æ±‚ä½“: ${body}`);
            
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });
                
                log(`â† å“åº”: ${response.status} ${response.statusText}`);
                const data = await response.json();
                log(`å“åº”æ•°æ®: ${JSON.stringify(data)}`);
                
                if (response.status === 200) {
                    log('<span style="background: #d4edda; color: #155724; padding: 2px 4px;">âœ“ è¯·æ±‚æˆåŠŸ!</span>');
                } else if (response.status === 422) {
                    log('<span style="background: #f8d7da; color: #721c24; padding: 2px 4px;">âœ— éªŒè¯é”™è¯¯!</span>');
                    if (Array.isArray(data.detail)) {
                        data.detail.forEach(err => {
                            log(`  âš  ${err.loc.join('.')}: ${err.msg}`);
                        });
                    }
                }
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
            }
        }
        
        async function sendPOST() {
            const formData = getFormData();
            
            let requestData = {
                name: formData.name,
                provider: formData.provider,
                model_type: formData.modelType
            };
            if (formData.maxTokens !== undefined && !isNaN(formData.maxTokens)) requestData.max_tokens = formData.maxTokens;
            if (formData.temperature !== undefined && !isNaN(formData.temperature)) requestData.temperature = formData.temperature;
            if (formData.endpoint) requestData.endpoint = formData.endpoint;
            if (formData.apiKey) requestData.api_key = formData.apiKey;
            if (formData.baseUrl) requestData.base_url = formData.baseUrl;
            if (formData.description) requestData.description = formData.description;
            
            const url = '/api/llm/models';
            const body = JSON.stringify(requestData);
            
            log(`â†’ å‘é€ POST è¯·æ±‚åˆ° ${url}`);
            log(`è¯·æ±‚ä½“: ${body}`);
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });
                
                log(`â† å“åº”: ${response.status} ${response.statusText}`);
                const data = await response.json();
                log(`å“åº”æ•°æ®: ${JSON.stringify(data)}`);
                
                if (response.status === 200 || response.status === 201) {
                    log('<span style="background: #d4edda; color: #155724; padding: 2px 4px;">âœ“ è¯·æ±‚æˆåŠŸ!</span>');
                }
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
            }
        }
        
        // åˆå§‹åŒ–
        log('âœ“ æµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>
